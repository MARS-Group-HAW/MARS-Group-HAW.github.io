"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7167],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>y});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=c(n),m=r,y=d["".concat(s,".").concat(m)]||d[m]||u[m]||i;return n?a.createElement(y,o(o({ref:t},p),{},{components:n})):a.createElement(y,o({ref:t},p))}));function y(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:r,o[1]=l;for(var c=2;c<i;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},70680:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var a=n(87462),r=(n(67294),n(3905));const i={sidebar_position:30},o="Layers",l={unversionedId:"tutorial/development/layers",id:"tutorial/development/layers",title:"Layers",description:"Layers represent the environment in which agents live. They serve as surrounding for their dependent agents. In this context, they are responsible to create their agents. Do not confuse layers with the `Environment`-type that is a data structure that is used for moving and exploring spatial objects (agents and entities). A layer may however use an environment that is used by its agents.",source:"@site/docs/tutorial/development/layers.md",sourceDirName:"tutorial/development",slug:"/tutorial/development/layers",permalink:"/docs/tutorial/development/layers",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/tutorial/development/layers.md",tags:[],version:"current",sidebarPosition:30,frontMatter:{sidebar_position:30},sidebar:"tutorialSidebar",previous:{title:"Entity",permalink:"/docs/tutorial/development/entity"},next:{title:"Spawning and Removing Agents and Entities",permalink:"/docs/tutorial/development/spawning"}},s={},c=[{value:"Basic Layer",id:"basic-layer",level:2},{value:"Dependent Layer",id:"dependent-layer",level:2},{value:"Active Layer",id:"active-layer",level:3},{value:"Data Layer",id:"data-layer",level:2},{value:"Raster Layer",id:"raster_layer",level:3},{value:"Vector Layer",id:"vector-layer",level:3}],p={toc:c};function d(e){let{components:t,...i}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"layers"},"Layers"),(0,r.kt)("p",null,"Layers represent the ",(0,r.kt)("em",{parentName:"p"},"environment")," in which agents ",(0,r.kt)("em",{parentName:"p"},"live"),". They serve as surrounding for their dependent agents. In this context, they are responsible to create their agents. Do not confuse layers with the ",(0,r.kt)("a",{parentName:"p",href:"/docs/tutorial/development/environments/"},(0,r.kt)("inlineCode",{parentName:"a"},"Environment"),"-type")," that is a data structure that is used for moving and exploring spatial objects (",(0,r.kt)("a",{parentName:"p",href:"/docs/tutorial/development/agent"},"agents")," and ",(0,r.kt)("a",{parentName:"p",href:"/docs/tutorial/development/entity"},"entities"),"). A layer may however use an environment that is used by its agents. "),(0,r.kt)("p",null,"Moreover, layers may hold and provide data, depending on their type.  They offer possibilities for input of various data formats (",(0,r.kt)("a",{parentName:"p",href:"../data-sources/"},"see more information about possible inputs"),"). "),(0,r.kt)("p",null,"Layers are the central model element in a MARS model and are automatically generated by the MARS runtime system and mutual dependencies between different layers are resolved. They require to be registered in the ",(0,r.kt)("a",{parentName:"p",href:"/docs/tutorial/development/model"},"model description"),"."),(0,r.kt)("p",null,"In MARS, the following layers are distinguished"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#basic-layer"},"Basic Layer")),(0,r.kt)("li",{parentName:"ul"},"Layers with dependencies or activity",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#dependent-layer"},"Dependent Layer")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#active-layer"},"Active Layer")))),(0,r.kt)("li",{parentName:"ul"},"Data Layer",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#vector-layer"},"Vector Layer")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#raster-layer"},"Raster Layer"))))),(0,r.kt)("p",null,"The layer ",(0,r.kt)("inlineCode",{parentName:"p"},"ILayer")," contract is structured as follows:"),(0,r.kt)("mermaid",{value:"classDiagram\n    IModelObject <|-- ILayer\n    ILayer <|-- IDataLayer\n\n    class IModelObject {\n        <<interface>>\n    }\n    class ILayer {\n        <<interface>>\n        +InitLayer(layerInitData:TInitData, registerAgentHandle:RegisterAgent, unregisterAgentHandle:UnregisterAgent) bool\n        +GetCurrentTick() long\n        +SetCurrentTick(currentStep:long)\n    }\n    class IDataLayer {\n        <<interface>>\n    }"}),(0,r.kt)("h2",{id:"basic-layer"},"Basic Layer"),(0,r.kt)("p",null,"To define a layer the ",(0,r.kt)("inlineCode",{parentName:"p"},"ILayer")," interface must be implemented ",(0,r.kt)("strong",{parentName:"p"},"or")," inherited from the existing abstract implementation ",(0,r.kt)("inlineCode",{parentName:"p"},"AbstractLayer"),". "),(0,r.kt)("p",null,"In the model code, a ",(0,r.kt)("inlineCode",{parentName:"p"},"using")," import for the namespace ",(0,r.kt)("inlineCode",{parentName:"p"},"Mars.Components.Layers")," must be added to the own model file."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"using Mars.Components.Layers;\n")),(0,r.kt)("p",null,"Then a new layer type can be defined in the form of a class that inherits from the abstract class ",(0,r.kt)("inlineCode",{parentName:"p"},"AbstractLayer"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"public class MyLayer : AbstractLayer\n{\n        public override bool InitLayer(TInitData layerInitData, RegisterAgent registerAgentHandle, UnregisterAgent unregisterAgentHandle)\n    {\n        base.InitLayer(layerInitData, registerAgentHandle, unregisterAgentHandle);\n        // Do your initialization logic here.\n        return true;\n    } \n}\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"InitLayer")," method can be used to execute custom logic, to initialize ",(0,r.kt)("a",{parentName:"p",href:"/docs/tutorial/development/environments/"},"Environments")," or to ",(0,r.kt)("a",{parentName:"p",href:"/docs/tutorial/development/spawning"},"Spawning")," agents."),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Please note to call the base implementation ",(0,r.kt)("inlineCode",{parentName:"p"},"base.InitLayer(layerInitData, registerAgentHandle, unregisterAgentHandle);")," to ensure correct initialization along the class hierarchy.")),(0,r.kt)("p",null,"Layer needs to be registered in the ",(0,r.kt)("inlineCode",{parentName:"p"},"ModelDescription")," by calling the ",(0,r.kt)("inlineCode",{parentName:"p"},"AddLayer<TLayer>()")," in your entry point ",(0,r.kt)("inlineCode",{parentName:"p"},"Main()")," method, to be an active part of the simulation. Active means here that the layer will be managed (initialized and referenced in other active entities) by the MARS framework."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"private static void Main(string[] args)\n{\n var description = new ModelDescription();\n description.AddLayer<MyLayer>();\n //...\n}\n")),(0,r.kt)("h2",{id:"dependent-layer"},"Dependent Layer"),(0,r.kt)("p",null,"If layers needs references to other layer for object and direct agent interaction or just to access data layer, the definition of dependent layers is necessary. Dependent layers are acquired by defining the layer instance as a ",(0,r.kt)("strong",{parentName:"p"},"property"),". MARS resolves this dependency by using ",(0,r.kt)("inlineCode",{parentName:"p"},"PropertyInjection")," to ",(0,r.kt)("strong",{parentName:"p"},"automatically")," and assigns the dependent layer to this property."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Cyclic dependencies between Layer can be defined as well, but this is an indication for a bad conceptual design.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"public class MyLayer : AbstractLayer\n{\n    [PropertyDescription]\n    public MyDependentLayer DependentLayer { get; set; }\n}\n")),(0,r.kt)("h3",{id:"active-layer"},"Active Layer"),(0,r.kt)("p",null,"If the layer requires to act within the simulation, it can be made active, which provides the possibility to act before, after and within the tick. The interface ",(0,r.kt)("inlineCode",{parentName:"p"},"ISteppedActiveLayer")," will get ticked by the ",(0,r.kt)("inlineCode",{parentName:"p"},"LayerContainer"),", just as the average ",(0,r.kt)("inlineCode",{parentName:"p"},"ITickClient"),". In Addition, it provides to more methods which allow hooking into the moment just before and after a tick."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"public class MyLayer : ISteppedActiveLayer\n{\n    public void Tick()\n    {\n        //do something this tick\n    }\n\n    public void PreTick()\n    {\n        //do something bevore the tick\n    }\n\n    public void PostTick()\n    {\n        //do something after the tick\n    }\n}\n")),(0,r.kt)("p",null,"The base implementation of the ",(0,r.kt)("inlineCode",{parentName:"p"},"ISteppedActiveLayer")," interface is the ",(0,r.kt)("inlineCode",{parentName:"p"},"AbstractActiveLayer")," where each step phase (pre, tick, post) can be overridden and activated for a stepwise behavior on a layer type."),(0,r.kt)("h2",{id:"data-layer"},"Data Layer"),(0,r.kt)("p",null,"There are different layer types provides, to integrate data into the model and make it available for agents. To represent spatial components of the model MARS offers raster and vector layers, which can be used to represent the simulation world under consideration (e.g. temperatures, landscapes, buildings, roads, passive objects). All layers can be found in the package ",(0,r.kt)("inlineCode",{parentName:"p"},"Mars.Components.Layers"),"."),(0,r.kt)("p",null,"In the model code a ",(0,r.kt)("inlineCode",{parentName:"p"},"using")," import for the namespace ",(0,r.kt)("inlineCode",{parentName:"p"},"Mars.Components.Layers")," must be added to the own model file, if not already done."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"using Mars.Components.Layers;\n")),(0,r.kt)("h3",{id:"raster_layer"},"Raster Layer"),(0,r.kt)("p",null,"Raster layer and grid layer are able to process grid and raster data and can be viewed similar to a 2D matrix. Real numerical values are stored in a n x m matrix and have a certain semantic nominal value."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"IRaster")," contract provides the following functionalities:"),(0,r.kt)("mermaid",{value:'classDiagram\n\n\n    IRaster~TValue~ "<double>" <|-- IRaster\n    IRaster~TValue~ --\x3e "LowerLeft" Position\n    IRaster~TValue~ --\x3e "UpperRight" Position\n\n    IDataLayer <|-- IRasterLayer\n    IRaster <|-- IRasterLayer\n    IDataSet <|-- IRasterLayer\n\n    class IRaster {\n        <<interface>>\n        CalculateStatistics() : void\n    }\n\n    class IRasterLayer {\n        <<interface>>\n        GetValueByGeoPosition(coordinate:Position) double\n        GetValueByGridPosition(coordinate:Position) double\n    }\n\n    class IRaster~TValue~ {\n        <<interface>>\n        CurrentBand int <<get>>\n        NumBands : int <<get>>\n        Width : int <<get>>\n        Height : int <<get>>\n        CellHeight : double <<get>> <<set>>\n        CellWidth : double <<get>> <<set>>\n        StartColumn : int <<get>>\n        StartRow : int <<get>>\n        EndColumn : int <<get>>\n        EndRow : int <<get>>\n        NoDataValue : double <<get>> <<set>>\n        Maximum : double <<get>>\n        Mean : double <<get>>\n        Minimum : double <<get>>\n        ReadBlock(xOff:int, yOff:int, sizeX:int, sizeY:int) : IRaster<TValue>\n        WriteBlock(blockValues:IRaster<TValue>, xOff:int, yOff:int, xSize:int, ySize:int) : void\n    }\n\n    class Position {\n    }\n\n    class IDataLayer {\n    }\n\n    class IDataSet {\n    }'}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"HammerparkRaster",src:n(58926).Z,width:"1526",height:"882"})),(0,r.kt)("p",null,"The raster above shows a sample black area which is associated to concrete pixel value. This value can be used to solve problems such as, ",(0,r.kt)("em",{parentName:"p"},"querying a coordinate around the park"),"."),(0,r.kt)("p",null,"To define a grid layer a new layer must inherit from the abstract ",(0,r.kt)("inlineCode",{parentName:"p"},"RasterLayer"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"public class MyRasterLayer : RasterLayer\n{\n\n}\n")),(0,r.kt)("p",null,"The raster layer offers various operations for processing matrix data and allows e.g. k-NN ",(0,r.kt)("inlineCode",{parentName:"p"},"Explore")," queries for nearby cells and coordinates whose nuclei match a condition."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"explore")," is used to query all raster cells that are within a ",(0,r.kt)("inlineCode",{parentName:"p"},"radius")," and match a selection criterion."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"MyRasterLayer MyRaster { get; set; }\n...\nvar source = Position.CreatePosition(30,40);\nvar result MyRaster.Explore(source, 10, 5);\n")),(0,r.kt)("p",null,"The call ",(0,r.kt)("inlineCode",{parentName:"p"},"Explore(source, 10, 5)")," returns a sequence of the first ",(0,r.kt)("inlineCode",{parentName:"p"},"5")," cells with their values that are within the ",(0,r.kt)("inlineCode",{parentName:"p"},"radius")," of 10 steps starting from coordinate ",(0,r.kt)("inlineCode",{parentName:"p"},"(30,40)"),"."),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Please note that the semantic of the ",(0,r.kt)("inlineCode",{parentName:"p"},"radius")," you specify for the ",(0,r.kt)("inlineCode",{parentName:"p"},"Explore")," depends on the distance function used within the ",(0,r.kt)("inlineCode",{parentName:"p"},"raster-layer")," (",(0,r.kt)("inlineCode",{parentName:"p"},"Haversine")," with ",(0,r.kt)("inlineCode",{parentName:"p"},"meter")," for Geospatial, ",(0,r.kt)("inlineCode",{parentName:"p"},"Chebyshev")," for Grid).")),(0,r.kt)("p",null,"A fourth argument can be used to ",(0,r.kt)("em",{parentName:"p"},"optionally")," define a selection predicate to search for specific cells that meet a condition."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"MyRasterLayer MyRaster { get; set; }\n//...\nvar source = Position.CreatePosition(30,40);\nvar result MyRaster.Explore(source, 10, -1, cell => cell > 10);\n")),(0,r.kt)("p",null,"The call ",(0,r.kt)("inlineCode",{parentName:"p"},"Explore(source, 10, 5, cell => cell > 10)")," queries for all cells (",(0,r.kt)("inlineCode",{parentName:"p"},"-1"),") in the radius of ",(0,r.kt)("inlineCode",{parentName:"p"},"10")," whose cell value is greater than ",(0,r.kt)("inlineCode",{parentName:"p"},"10"),"."),(0,r.kt)("h3",{id:"vector-layer"},"Vector Layer"),(0,r.kt)("p",null,"Vector layers are used to map vector objects that can be represented by points, lines or areas. Vector objects are the most commonly used types for modeling the simulated environment."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"HammerparkRaster",src:n(10377).Z,width:"1500",height:"878"})),(0,r.kt)("p",null,"The vector layer above shows an example vector layer, building the closed area to represent the park to solve problems such as ",(0,r.kt)("em",{parentName:"p"},"Checking for position, whether they are inside the park or not"),".",(0,r.kt)("br",{parentName:"p"}),"\n","To define a vector layer, a new layer must inherit from the abstract VectorLayer:"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"IVectorLayer")," contract is providing the following functionalities:"),(0,r.kt)("mermaid",{value:'classDiagram\n    ILayer <|-- IVectorLayer\n\n    IVectorLayer --\x3e "GeometryCollection" IGeometryCollection\n    IVectorLayer --\x3e "Features<IVectorFeature>" Collection1~T~\n\n    IVectorLayer <|-- IVectorLayer1~T~\n    IDataLayer <|-- IVectorLayer1~T~\n\n    IVectorLayer1~T~ --\x3e "TimeSeriesData<DateTime,double>" SortedList2~T1,T2~\n    IVectorLayer1~T~ --\x3e "CoordinateReferenceSystem" ICRSObject\n\n    class ILayer {\n        <<interface>>\n    }\n\n    class IVectorLayer {\n        <<interface>>    \n        SerializeJson() string\n        SerializeFeaturesJson() IEnumerable<string>\n    }\n\n    class IVectorLayer1~T~{\n        <<interface>>\n        CurrentTsIndex int <<get>>\n        GetClosestPoint(gpsCoordinate:Position, maxDistance:double, predicate:Func<T, bool>) Position\n        Distance(featureIndex:int, coords:IEnumerable~Position~) double\n        IsPointInside(coordinate:Position) bool\n        IsMultiPointInside(coords:IEnumerable~Position~) bool\n        IsLineStringInside(coords:IEnumerable~Position~) bool\n        IsMultiPointCrossing(coords:IEnumerable~Position~) bool\n        IsLineStringCrossing(coords:IEnumerable~Position~) bool\n        IsMultiPointIntersecting(coords:IEnumerable~Position~) bool\n        IsLineStringIntersecting(coords:IEnumerable~Position~) bool\n        IsMultiPointOverlapping(coords:IEnumerable~Position~) bool\n        IsLineStringOverlapping(coords:IEnumerable~Position~) bool\n        GetAccumulatedPathRating(source:Position, target:Position, distance:int) double\n        GetAccumulatedPathRating(source:Position, distance:int, bearing:double) double\n        GetTimeseriesDataForCurrentTick() object\n        GetFromDataTable(featureId:int, key:string) object\n        AddToDataTable(featureId:int, key:string, value:object) void\n    }\n\n    class Collection1~T~ {\n    }\n\n    class SortedList2~T1,T2~ {\n    }\n    \n    class ICRSObject {\n\n    }'}),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"public class MyVectorLayer : VectorLayer\n{\n\n}\n")),(0,r.kt)("p",null,"Features of vector layers (points, lines, surfaces) can be individually abstracted by a model type in MARS. The ",(0,r.kt)("inlineCode",{parentName:"p"},"VectorLayer")," offers a more abstract implementation ",(0,r.kt)("inlineCode",{parentName:"p"},"VectorLayer<TFeatureType>")," for the definition of model types which can be initialized by concrete features from a vector input with data. "),(0,r.kt)("p",null,"An example for an abstract feature can look like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'public class MyVectorFeature : IVectorFeature\n{\n    public double MyFeatureValue { get; set; }\n    \n    public void Init(IFeature feature)\n    {\n        MyFeatureValue = feature.Attributes["valueAttributeName"].Value<double>();\n    }\n}\n')),(0,r.kt)("p",null,"If the ",(0,r.kt)("inlineCode",{parentName:"p"},"MyVectorLayer")," is queried, concrete ",(0,r.kt)("inlineCode",{parentName:"p"},"MyVectorFeature")," objects are returned and can be processed."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"myVectorLayer.Explore(new[] {9.99967, 53.55285}, 100, 10, myVectorFeature =>\n{\n    return myVectorFeature.MyFeatureValue > 20;\n});\n")))}d.isMDXComponent=!0},58926:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/perfect_raster_hammerpark-f8e60108e1113b8537dec1ecf94b8364.png"},10377:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/vector_hammerpark-40dc700a2059f260c5c211be268628f5.png"}}]);